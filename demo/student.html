<!DOCTYPE html>
<html lang="en">
    <head>
		<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
		<!-- Meta, title, CSS, favicons, etc. -->
		<meta charset="utf-8">
		<meta http-equiv="X-UA-Compatible" content="IE=edge">
		<meta name="viewport" content="width=device-width, initial-scale=1">
		
		<link rel="shortcut icon" href="static/favicon/favicon.ico">
		<link rel="icon" sizes="16x16 32x32 64x64" href="static/favicon/favicon.ico">
		<link rel="icon" type="image/png" sizes="196x196" href="static/favicon/favicon-192.png">
		<link rel="icon" type="image/png" sizes="160x160" href="static/favicon/favicon-160.png">
		<link rel="icon" type="image/png" sizes="96x96" href="static/favicon/favicon-96.png">
		<link rel="icon" type="image/png" sizes="64x64" href="static/favicon/favicon-64.png">
		<link rel="icon" type="image/png" sizes="32x32" href="static/favicon/favicon-32.png">
		<link rel="icon" type="image/png" sizes="16x16" href="static/favicon/favicon-16.png">
		<link rel="apple-touch-icon" href="static/favicon/favicon-57.png">
		<link rel="apple-touch-icon" sizes="114x114" href="static/favicon/favicon-114.png">
		<link rel="apple-touch-icon" sizes="72x72" href="static/favicon/favicon-72.png">
		<link rel="apple-touch-icon" sizes="144x144" href="static/favicon/favicon-144.png">
		<link rel="apple-touch-icon" sizes="60x60" href="static/favicon/favicon-60.png">
		<link rel="apple-touch-icon" sizes="120x120" href="static/favicon/favicon-120.png">
		<link rel="apple-touch-icon" sizes="76x76" href="static/favicon/favicon-76.png">
		<link rel="apple-touch-icon" sizes="152x152" href="static/favicon/favicon-152.png">
		<link rel="apple-touch-icon" sizes="180x180" href="static/favicon/favicon-180.png">
		<meta name="msapplication-TileColor" content="#FFFFFF">
		<meta name="msapplication-TileImage" content="static/favicon/favicon-144.png">
		<meta name="msapplication-config" content="static/browserconfig.xml">

		<title>Dashboard |  Student View </title>

		<!-- Bootstrap -->
		<link href="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.3.7/css/bootstrap.min.css" rel="stylesheet">
		<!-- Font Awesome -->
		<link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.6.3/css/font-awesome.min.css" rel="stylesheet">
		<!-- bootstrap-progressbar -->
		<!-- <link href="static/vendors/bootstrap-progressbar/css/bootstrap-progressbar-3.3.4.min.css" rel="stylesheet"> -->

		<!-- Custom Theme Style -->
		<link href="static/css/custom.css" rel="stylesheet">
	
</head>


    
<body class="nav-md">

        <div style="background-color: #222; color:lightgray; padding: 10px; padding-bottom:6px; margin: 0">
            <a href="https://pid-ub.github.io/" class="btn btn-success">Go to the project's website</a>
            <b>
                <i class="fa fa-info-circle"></i> This Dashboard Demo is part of the University of Barcelona Project "Intelligent Support System for Tutor of Studies".
            </b>
        </div>

        <div class="container body">
            <div class="main_container">
                <div class="col-md-3 left_col  " style="height: 100vh;">
                    <div class="left_col scroll-view">
                        <div class="navbar nav_title" style="border: 0;">
                            <a href="/demo" class="site_title">
                                <img src="static/images/branding/ub-shield-white.png" style="height: 46px; margin: 0 10px">
                                <span>
                                    <img src="static/images/branding/ub-text-white.png" height="34">
                                </span>
                            </a>
                        </div>
                        <div class="clearfix"></div>
                        <!-- menu profile quick info -->
                        <div class="profile clearfix">
                            <div class="profile_pic">
                                <img src="https://www.gravatar.com/avatar/a0ba33da55c23560097f507b99ea9d7a?d=http%3A%2F%2Fcarrotpiracy.com%3A8000%2Fimg%2Fuser.jpeg" alt="lauraigual@gmail.com" class="img-circle profile_img">
                            </div>
                            <div class="profile_info">
                                <span>Welcome,</span>
                                <h2>Laura Igual</h2>
                            </div>
                        </div>
                        <!-- /menu profile quick info -->
                        <br/>
                        <!-- sidebar menu -->
                        <div id="sidebar-menu" class="main_menu_side hidden-print main_menu">
                            <div class="menu_section">
                                <!--<h3>General</h3>-->
                                <ul class="nav side-menu">
                                    <li>
                                        <a>
                                            <i class="fa fa-home"></i>
                                            Home <span class="fa fa-chevron-down"></span>
                                        </a>
                                        <ul class="nav child_menu">
                                            <li>
                                                <a href="/demo">Home Page</a>
                                            </li>
                                            <li>
                                                <a href="#">Dept. of Mathematics</a>
                                            </li>
                                            <li>
                                                <a href="#">Dept. of Comp.Sci.</a>
                                            </li>
                                        </ul>
                                    </li>
                                    <li>
                                        <a>
                                            <i class="fa fa-user"></i>
                                            Profile <span class="fa fa-chevron-down"></span>
                                        </a>
                                        <ul class="nav child_menu">
                                            <li>
                                                <a href="#">My Profile</a>
                                            </li>
                                            <li>
                                                <a href="#">My Inbox</a>
                                            </li>
                                            <li>
                                                <a href="#">Contact My Tutor</a>
                                            </li>
                                            <li>
                                                <a href="#">View my stats</a>
                                            </li>
                                        </ul>
                                    </li>
                                    <li>
                                        <a>
                                            <i class="fa fa-sitemap"></i>
                                            Site <span class="fa fa-chevron-down"></span>
                                        </a>
                                        <ul class="nav child_menu">
                                            <li>
                                                <a href="/">About Us</a>
                                            </li>
                                        </ul>
                                    </li>

                                </ul>
                            </div>

                        </div>
                        <!-- /sidebar menu -->
                        <!-- /menu footer buttons -->
                        <div class="sidebar-footer hidden-small">
                            <a data-toggle="tooltip" data-placement="top" title="Settings">
                                <span class="glyphicon glyphicon-cog" aria-hidden="true"></span>
                            </a>
                            <a data-toggle="tooltip" data-placement="top" title="FullScreen">
                                <span class="glyphicon glyphicon-fullscreen" aria-hidden="true"></span>
                            </a>
                            <a data-toggle="tooltip" data-placement="top" title="Lock">
                                <span class="glyphicon glyphicon-eye-close" aria-hidden="true"></span>
                            </a>
                            <a data-toggle="tooltip" data-placement="top" title="Logout" href="#">
                                <span class="glyphicon glyphicon-off" aria-hidden="true"></span>
                            </a>
                        </div>
                        <!-- /menu footer buttons -->
                    </div>
                </div>
                <div class="top_nav">
                    <div class="nav_menu">
                        <nav>
                            <div class="nav toggle">
                                <a id="menu_toggle">
                                    <i class="fa fa-bars"></i>
                                </a>
                            </div>

                            <ul class="nav navbar-nav navbar-right" id="notification-app">

                                <li class="">
                                    <a href="javascript:" class="user-profile dropdown-toggle" data-toggle="dropdown" aria-expanded="false">
                                        <img src="https://www.gravatar.com/avatar/a0ba33da55c23560097f507b99ea9d7a?d=http%3A%2F%2Fcarrotpiracy.com%3A8000%2Fimg%2Fuser.jpeg" alt="">
                                        Laura Igual
					                    <span class=" fa fa-angle-down"></span>
                                    </a>
                                    <ul class="dropdown-menu dropdown-usermenu pull-right">
                                        <li>
                                            <a href="#">Profile</a>
                                        </li>
                                        <li>
                                            <a href="/demo">
                                                <span class="badge pull-right bg-white">20</span>
                                                <span>My Students</span>
                                            </a>
                                        </li>
                                        <li>
                                            <a href="#">
                                                <span class="badge pull-right bg-white">455</span>
                                                <span>Degree Dashboard</span>
                                            </a>
                                        </li>
                                        <li>
                                            <a href="#">Administration</a>
                                        </li>
                                        <li>
                                            <a href="#">
                                                <i class="fa fa-sign-out pull-right"></i>
                                                Log Out
                                            </a>
                                        </li>
                                    </ul>
                                </li>



                            </ul>
                        </nav>
                    </div>
                </div>
                <div class="right_col" role="main" style="height: calc(100vh - 58px); overflow:auto;">
                    <div id="app">
                        <!--
		<div class="page-title">
			<div class="title_left">
				<h3>Student Profile</h3>
			</div>
		</div>
		<div class="clearfix"></div>
		-->
                        <div class="row">
                            <div class="col-xs-12">
                                <div v-cloak class="x_title" v-if="isDropout()" style="background-color: rgb(255, 87, 87);
						border-radius: 5px;color: white; border: 0px; padding: 4px 12px; text-shadow: gray 1px 1px 1px;
						margin: 14px 0">
                                    <h2>
                                        <i class="fa fa-warning"></i>
                                        Projected Dropout
						<small style="color:white">Warning: This student is predicted to Dropout. Tutorial intervention suggested.</small>
                                    </h2>
                                    <div class="clearfix"></div>
                                </div>
                            </div>
                            <!-- Profile info and Image -->
                            <div id="profile-info" class="col-sm-5 col-xs-12">
                                <div class="x_panel">
                                    <div class="x_title">
                                        <h2>
                                            <i class="fa fa-user"></i>
                                            Profile
						<small>About you</small>
                                        </h2>
                                        <div class="clearfix"></div>
                                    </div>
                                    <div class="x_content" style="height:280px">
                                        <div class="row">
                                            <div class="col-xs-6">
                                                <img src="https://www.gravatar.com/avatar/e1e0faca08747175e723ababf444de51?d=http%3A%2F%2Fcarrotpiracy.com%3A8000%2Fimg%2Fuser.jpeg&s=512" style="width:80%; margin-top:5%; margin-left:10%; max-width:200px; max-height:200px"/>
                                            </div>
                                            <div class="col-xs-6">
                                                <dl v-if="records.length > 0">
                                                    <dt>Full Name</dt>
                                                    <dd style="margin-left:20px">Arturo Belanche</dd>
                                                    <dt>Email</dt>
                                                    <dd style="margin-left:20px">arturo@ub.edu</dd>
                                                    <dt>Year Started</dt>
                                                    <dd style="margin-left:20px">[[ records[0].yearStarted ]]</dd>
                                                    <dt>Degrees Coursed</dt>
                                                    <dd style="margin-left:20px">[[ records.length ]]</dd>
                                                    <dt>Graduated</dt>
                                                    <dd style="margin-left:20px">No</dd>
                                                </dl>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <!-- Records Summary -->
                            <div id="profile-summary" class="col-sm-7 col-xs-12">
                                <div class="x_panel">
                                    <div class="x_title">
                                        <h2>
                                            <i class="fa fa-newspaper-o"></i>
                                            Summary
							<small>Current standing</small>
                                        </h2>
                                        <div class="clearfix"></div>
                                    </div>
                                    <div v-cloak class="x_content" style="height:280px; overflow-y:hidden; overflow-x:hidden">
                                        <div role="tabpanel">
                                            <!-- VUE -->
                                            <ul class="nav nav-tabs bar_tabs" role="tablist">
                                                <li v-for="(record, i) in records" role="presentation" :class="{active:i==0}">
                                                    <a :href="'#tab_summary_'+record.id" role="tab" data-toggle="tab" :aria-expanded="i==0">[[record.degree.name]]</a>
                                                </li>
                                            </ul>
                                        </div>
                                        <div class="tab-content" style="height:calc(100% - 67px); position:relative;">
                                            <div v-for="(record, i) in records" role="tabpanel" :id="'tab_summary_'+record.id" :class="{'tab-pane':true, 'row':true, 'fade':true, 'active':i==0, 'in':i==0}" style="position: absolute; top: 50%; transform: translateY(-50%); width:100%;">
                                                <div class="col-xs-3 text-center">
                                                    <h4>
                                                        Rank<br>
                                                        <span style="font-size: 4rem; line-height:1.1">[[getRecordRank(record)]]</span>
                                                    </h4>
                                                    <p>You are in the top [[record.percentile]]% of students</p>
                                                </div>
                                                <div class="col-xs-5">
                                                    <div style="position:relative; height:180px">
                                                        <canvas :id="'record-report-'+record.id"></canvas>
                                                    </div>
                                                </div>
                                                <!-- Yearly Report -->
                                                <div class="col-xs-4">
                                                    <table class="table table-striped" style="margin:0; width:100%">
                                                        <thead>
                                                            <tr>
                                                                <th>Year</th>
                                                                <th>Average</th>
                                                            </tr>
                                                        </thead>
                                                        <tbody>
                                                            <tr v-for="yearly in record.yearlyAverage">
                                                                <td>
                                                                    <b>[[ yearly.year ]]</b>
                                                                </td>
                                                                <td>
                                                                    <div class="progress" style="margin:0">
                                                                        <div :class="getBGClasses(yearly.value)" role="progressbar" :style="'width:' + (yearly.value * 10) + '%;'">
                                                                            <b>[[ yearly.value ]]</b>
                                                                        </div>
                                                                    </div>
                                                                </td>
                                                            </tr>
                                                        </tbody>
                                                    </table>
                                                </div>
                                            </div>
                                        </div>
                                        <!-- end tab content -->
                                    </div>
                                </div>
                            </div>
                            <!-- User Grades grouped by year
			<div id ="profile-summary-old" class="col-sm-6 col-xs-12">
				<div class="x_panel">
					<div class="x_title">
						<h2><i class="fa fa-newspaper-o"></i> Summary
							<small>Current standing</small>
						</h2>
						<div class="clearfix"></div>
					</div>
					<div class="x_content" style="height:240px">

						<h2>University Grades</h2>

						<div style="position:relative; height:180px">
							<canvas id="grades-histogram"></canvas>
						</div>

					</div>
				</div>
			</div>
			-->
                            <!-- Student Academic Record -->
                            <div id="academic-records" class="col-xs-12">
                                <div class="x_panel">
                                    <div class="x_title">
                                        <h2>
                                            <i class="fa fa-university"></i>
                                            Academic Records
							<small>All your grades in one place</small>
                                        </h2>
                                        <div class="clearfix"></div>
                                    </div>
                                    <div v-cloak class="x_content" style="min-height: 250px">
                                        <div role="tabpanel">
                                            <!-- VUE -->
                                            <ul class="nav nav-tabs bar_tabs" role="tablist">
                                                <li v-for="(record, i) in records" role="presentation" :class="{active:i==0}">
                                                    <a :href="'#tab_'+record.id" role="tab" data-toggle="tab" :aria-expanded="i==0">[[record.degree.name]]</a>
                                                </li>
                                            </ul>
                                            <div class="tab-content">
                                                <div v-for="(record, i) in records" role="tabpanel" :id="'tab_'+record.id" :class="{'tab-pane':true, fade:true, active:i==0, in:i==0}">
                                                    <h2>Grades per School Year</h2>
                                                    <div style="position: relative; height: 320px; display: flex">
                                                        <div v-for="yearly,i in record.byYear" style="flex:1; max-width:33%; overflow:hidden">
                                                            <canvas :id="'record-' + record.id + '-year-' + (i+1)" style="width:100%; height:100%"></canvas>
                                                        </div>
                                                    </div>
                                                    <a href='#' class="h4 pull-right" onclick="$('div[id^=\'grades-\']').slideDown()">
                                                        <i class="fa fa-plus-square "></i>
                                                        Expand All
                                                    </a>
                                                    <br>
                                                    <div v-for="yearly, i in record.byYear">
                                                        <a href='#' class="h4" :onclick="toggler('grades-'+record.id+'-'+(i+1))">
                                                            <i class="fa fa-chevron-right"></i>
                                                            Grades in [[ yearly.year ]]
                                                        </a>
                                                        <!-- Grades Table -->
                                                        <div :id="'grades-'+record.id+'-'+(i+1)" style="display:none">
                                                            <table class="table table-hover table-striped table-condensed">
                                                                <colgroup>
                                                                    <col span="1" style="width: 10%;">
                                                                    <col span="1" style="width: 60%;">
                                                                    <col span="1" style="width: 20%;">
                                                                    <col span="1" style="width: 10%;">
                                                                </colgroup>
                                                                <thead>
                                                                    <th>Code</th>
                                                                    <th>Course</th>
                                                                    <th>Year</th>
                                                                    <th>Grade</th>
                                                                </thead>
                                                                <tbody>
                                                                    <tr v-for="grade in yearly.gradeSet" :class="{'bg-red': grade.value<5, 'bg-blue-sky' : grade.predicted}">
                                                                        <td>
                                                                            <b>[[grade.course.tag]]</b>
                                                                        </td>
                                                                        <td>[[grade.course.name]]</td>
                                                                        <td>[[grade.predicted ? "Predicted" : grade.year]]</td>
                                                                        <td>[[grade.value.toFixed(2)]]</td>
                                                                    </tr>
                                                                </tbody>
                                                            </table>
                                                        </div>
                                                        <!-- End Grades Table -->
                                                        <hr>
                                                    </div>
                                                </div>
                                            </div>
                                            <!-- ENDVUE -->
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="row" style="margin-top: 20px">
                        <div class="pull-right">
                            Espai Tutorial | <a href="https://ub.edu">Universitat de Barcelona</a>
                            2017-18
                        </div>
                        <div class="clearfix"></div>
                    </div>
                </div>
                <footer class="hidden-xs" style="display:none">
                    <div class="pull-right">
                        Espai Tutorial | <a href="https://ub.edu">Universitat de Barcelona</a>
                        2017-18
                    </div>
                    <div class="clearfix"></div>
                </footer>
            </div>
        </div>
        <!-- CDN JS -->
        <script src="https://unpkg.com/vue@2.5.13/dist/vue.js"></script>
        <script src="https://unpkg.com/vue-router@3.0.1/dist/vue-router.js"></script>
        <script src="https://unpkg.com/axios/dist/axios.min.js"></script>
        <!-- <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/2.4.0/Chart.min.js"></script> -->
        <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/2.7.2/Chart.min.js"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/nprogress/0.2.0/nprogress.min.js"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/2.2.4/jquery.min.js"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/fastclick/1.0.6/fastclick.min.js"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.20.1/moment.min.js"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.20.1/locale/es.js"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.20.1/locale/ca.js"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.20.1/locale/en-gb.js"></script>
        <script src="static/vendors/bootstrap/dist/js/bootstrap.min.js"></script>
        <script src="static/vendors/bootstrap-progressbar/bootstrap-progressbar.min.js"></script>
        <!-- <script src="static/vendors/jquery/dist/jquery.min.js"></script> -->
        <!-- <script src="static/vendors/fastclick/lib/fastclick.js"></script> -->
        <!-- <script src="static/vendors/vue/vue.js"></script> -->
        <!-- <script src="static/vendors/moment/min/moment.min.js"></script> -->
        <!-- <script src="static/vendors/nprogress/nprogress.js"></script> -->
        <!-- <script src="static/vendors/Chart.js/dist/Chart.min.js"></script> -->
        <!-- <script src="static/vendors/nprogress/nprogress.js"></script> -->
        <!-- <script src="static/vendors/bootstrap-daterangepicker/daterangepicker.js"></script> -->
        <!-- <script src="static/vendors/jquery.tagsinput/src/jquery.tagsinput.js"></script> -->
        <!-- <script src="static/vendors/select2/dist/js/select2.full.min.js"></script> -->
        <!-- <script src="static/vendors/devbridge-autocomplete/dist/jquery.autocomplete.min.js"></script> -->
        <script src="static/js/custom.js"></script>
        <script>

            /* Config */
            axios.defaults.xsrfCookieName = 'csrftoken'
            axios.defaults.xsrfHeaderName = 'X-CSRFToken'

            window.chartColors = {
                green: 'rgba(65, 192, 160, 1)',
                yellow: 'rgba(255, 205, 86, 1)',
                red: 'rgba(255, 99, 132, 1)',
                purple: 'rgba(153, 102, 255, 1)',
                grey: 'rgba(201, 203, 207, 1)',
                orange: 'rgba(255, 159, 64, 1)',
                blue: 'rgba(54, 162, 235, 1)',
                trans: 'rgba(0,0,0,0)',
            };

            let locale = "en";
            moment.locale(locale);
            

            Vue.filter('fromNow', val=>moment(val).fromNow())
            Vue.filter('cut', val=>{
                val = val.replace(/<(?:.|\n)*?>/gm, '');
                if (val.length > 50)
                    return val.slice(0, 50) + "...";
                return val
            })

        </script>

        <script>

            window.charts = {}

            const yearTags = [['P1', 'DDB', 'IO', 'ALGE', 'CAL', 'MD', 'FIS', 'ALGO', 'P2', 'ED', 'ADIP', 'ELPR', 'IACD', 'LIRM', 'MAVE', 'ALLI', 'ARIT', 'FISI', 'IACI', 'PRCI'], ['ELEC', 'AA', 'DS', 'EC', 'ICC', 'EMP', 'PIE', 'PAE', 'PIS', 'SO1', 'CDDV', 'ESAL', 'GELI', 'GRAF', 'MNU1', 'CIDV', 'GEPR', 'HIMA', 'MMSD', 'TOPO'], ['IA', 'SO2', 'TNUI', 'VA', 'XAR', 'BD', 'FHIC', 'GiVD', 'LIL', 'SWD', 'ANMA', 'EQAL', 'GDCS', 'MNU2', 'PROB', 'ANCO', 'EQDI', 'ESTA', 'MODE', 'TGGS']]

            /* GroupBy function, Source: https://stackoverflow.com/a/38327540 */
            function groupBy(list, keyGetter) {
                const map = new Map();

                list.forEach( (item) =>{
                    const key = keyGetter(item);
                    const collection = map.get(key);
                    if (!collection) {
                        map.set(key, [item]);
                    } else {
                        collection.push(item);
                    }
                });

                return map;
            }

            vm = new Vue({
                el: "#app",
                delimiters: ['[[', ']]'],
                data: {
                    records: [],
                    histoChart: null,
                },

                methods: {
                    isDropout() {
                        return this.records.reduce((a,b)=>a.predDropout || b.predDropout, false);
                    },

                    getRecordRank(record) {
                        if (record.percentile <= 1)
                            return "S";
                        if (record.percentile <= 10)
                            return "A";
                        if (record.percentile <= 25)
                            return "B";
                        if (record.meanGrade >= 5)
                            return "C";
                        return "D";
                    },

                    getBGClasses(grade) {
                        let color = 'bg-green';
                        if (grade < 7)
                            color = 'bg-orange';
                        if (grade < 5)
                            color = 'bg-red';
                        return `progress-bar ${color}`
                    },

                    toggler(selector) {
                        return `$('#${selector}').slideToggle();`;
                    },

                    createUserGraphs() {
                        let yearColors = [window.chartColors.green, window.chartColors.yellow, window.chartColors.red, window.chartColors.purple, window.chartColors.grey, window.chartColors.grey, ]

                        let yearColorsPredicted = yearColors.map(c=>c.replace('1)', '.05)'));
                        let yearColorsBorder = yearColors.map(c=>c.replace('1)', '.75)'));

                        this.records.forEach(function(record) {

                            record.byYear.forEach((yearly,i)=>{
                                let selectorID = 'record-' + record.id + '-year-' + (i + 1);
                                let ctx = document.getElementById(selectorID).getContext('2d');

                                let reducedSet = []
                                let grouped = groupBy(yearly.gradeSet, grade=>grade.course.tag)

                                grouped.forEach((grades,tag)=>{
                                    if (grades.length == 1) {
                                        // Easy peasy, take single grade
                                        let grade = grades[0]
                                        grade.failed = false
                                        reducedSet.push(grade)

                                    } else {
                                        // Get how many predictions there are
                                        let predicted = grades.filter(g=>g.predicted)

                                        if (predicted.length > 0) {
                                            // Push first prediction
                                            let grade = predicted[0]
                                            grade.failed = true
                                            reducedSet.push(predicted[0])
                                        }
                                        else {
                                            // Many attempts, none is prediction => failed one year passed the next => pick latest
                                            let grade = grades.reduce((a,b)=>a.year > b.year ? a : b)
                                            grade.failed = true
                                            reducedSet.push(grade)

                                        }
                                    }
                                }
                                )

                                console.log(reducedSet)

                                let graphGrades = reducedSet

                                let labels = graphGrades.map(g=>"    " + g.course.tag.slice(-4))

                                let datasets = [{
                                    data: graphGrades.map(g=>g.value),
                                    backgroundColor: graphGrades.map(g=>{
                                        return g.predicted ? window.chartColors.trans : (g.failed ? window.chartColors.orange : window.chartColors.green)
                                    }
                                    ),
                                    borderColor: graphGrades.map(g=>!g.failed ? window.chartColors.green : (g.predicted ? window.chartColors.red : window.chartColors.orange)),
                                    borderWidth: 2,
                                }];

                                while (labels.length < 10) {
                                    datasets[0].data.push(0)
                                    labels.push("")
                                }

                                new Chart(ctx,{
                                    type: 'bar',
                                    data: {
                                        label: "First Year",
                                        labels: labels,
                                        datasets: datasets
                                    },
                                    options: {
                                        title: {
                                            text: `Courses in Year ${i + 1}`,
                                            display: true
                                        },
                                        legend: {
                                            display: false
                                        },
                                        maintainAspectRatio: false,
                                        scales: {
                                            xAxes: [{
                                                fontFamily: "monospace",
                                                gridLines: {
                                                    color: "rgba(0, 0, 0, .1)",
                                                    zeroLineColor: i == 0 ? "rgba(0,0,0,0.5)" : "rgba(0,0,0,0)"
                                                },
                                                barPercentage: 0.7,
                                                ticks: {
                                                    fontFamily: "monospace",
                                                    fontSize: 13,
                                                    autoSkip: false,
                                                    maxRotation: 45,
                                                    minRotation: 45
                                                }
                                            }],
                                            yAxes: [{
                                                gridLines: {
                                                    drawBorder: i == 0,
                                                    color: "rgba(0, 0, 0, 0)",
                                                },
                                                ticks: {
                                                    display: i == 0,
                                                    min: 0,
                                                    max: 10,
                                                    stepsize: 2,
                                                    beginAtZero: true
                                                }
                                            }]
                                        },
                                        animation: {
                                            onComplete: function() {
                                                let chartInstance = this.chart;
                                                let ctx = chartInstance.ctx;

                                                ctx.font = Chart.helpers.fontString(Chart.defaults.global.defaultFontSize, Chart.defaults.global.defaultFontStyle, Chart.defaults.global.defaultFontFamily);
                                                ctx.textAlign = 'center';
                                                ctx.textBaseline = 'bottom';

                                                ctx.fillStyle = 'rgba(0,0,0,.8)'

                                                this.data.datasets.forEach(function(dataset, i) {
                                                    if (dataset.type == "line")
                                                        return;

                                                    // Add Text over Bars
                                                    for (let meta_index in dataset._meta) {
                                                        let meta = dataset._meta[meta_index];
                                                        meta.data.forEach((bar,index)=>{
                                                            var data = dataset.data[index];
                                                            if (data != 0)
                                                                ctx.fillText(data, bar._model.x, bar._model.y - 5);
                                                        }
                                                        );
                                                    }

                                                });
                                            }
                                        },
                                        tooltips: {
                                            callbacks: {

                                                label: function(tooltipItem, data) {
                                                    // Label data, tagged by year
                                                    let tag = tooltipItem.xLabel.trim()
                                                    let history = grouped.get(tag)
                                                    let ttip = []
                                                    history.forEach(g=>{
                                                        ttip.push(` ${g.predicted ? "Predicted" : g.year}: ${g.value.toFixed(2)}`)
                                                    }
                                                    )
                                                    return ttip;
                                                }

                                            }
                                        }
                                    },

                                },this);

                            }
                            );

                        }, this);

                    },

                    createRecordReportGraphs() {
                        this.records.forEach(record=>{
                            let ctx = document.getElementById(`record-report-${record.id}`).getContext('2d');

                            let passed = record.gradeSet.filter(g=>!g.predicted && g.value >= 5).length
                            let failed = record.gradeSet.filter(g=>!g.predicted && g.value < 5).length

                            let config = {
                                type: 'doughnut',
                                data: {
                                    datasets: [{
                                        data: [passed, failed],
                                        backgroundColor: [window.chartColors.green, window.chartColors.red, ],
                                        label: record.degree.name
                                    }],
                                    labels: ["Passed", "Failed"]
                                },
                                options: {
                                    maintainAspectRatio: false,
                                    legend: {
                                        position: 'bottom',
                                    },
                                    title: {
                                        display: false,
                                        text: ''
                                    },
                                    animation: {
                                        animateScale: true,
                                        animateRotate: true
                                    }
                                }
                            };

                            new Chart(ctx,config);
                        }
                        );
                    },

                    createGraphs() {
                        this.createUserGraphs();
                        this.createRecordReportGraphs();

                        NProgress.done();
                    }

                },

                computed: {
                    meanGrade() {
                        if (this.records.length == 1)
                            return Math.round(this.records[0].meanGrade);
                        return meanGrade = Math.round(this.records.reduce((a,b)=>(a.meanGrade + b.meanGrade) / 2))
                    }
                },

                mounted: function() {
                    NProgress.start();
                    axios.get('data/student-ok.json').then(response=>{

                        let records = response.data.data.records;

                        /* Sort records into a special property grouped by year. */
                        records.forEach(function(record) {
                            record.gradeSet.sort((a,b)=>a.year - b.year);

                            record.byYear = [];

                            yearTags.forEach((tagList,i)=>{
                                let gradeSet = record.gradeSet.filter(g=>tagList.indexOf(g.course.tag) >= 0);
                                if (gradeSet.length > 0)
                                    record.byYear.push({
                                        year: `School Year ${i + 1}`,
                                        gradeSet
                                    });
                            }
                            , this)

                        }, this);

                        this.records = records;

                        NProgress.inc();
                        setTimeout(this.createGraphs, 200);

                    })

                }
            });
        </script>
        <!-- Custom Theme Scripts -->
    </body>
</html>
